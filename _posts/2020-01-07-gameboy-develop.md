---
layout: post
title:  "Gameboy游戏开发"
date:   2020-1-1 1:1:1
categories: gameboy game develop
---

Gameboy是80、90后童年曾经陪伴过的掌上游戏机，给我们儿时带来了很多欢乐。我还记得我的GB是96年时用压岁钱买的，当时从父母那里收了200的压岁钱，自己用平时积攒的200块钱自己坐了2个小时的车去了大城市锦州买的这台游戏机。当时已经没有钱再买游戏卡了，还是从我们这叫老六那租的游戏卡一块钱一天。当时也想好奇过GB上的游戏是怎么做出来的？好奇归好奇那个年代信息闭塞不太可能知道答案。

![gameboy picture](//blog.guohai.org/doc-pic/2020-01/oldgb.jpg)

今天互联网发达了，我儿时的梦想也算可以实现了。GB的原生开发都是使用汇编语言操作z80CPU，但汇编的学习曲线有点长，网上有人做了个c语言的封装类库。虽然执行效率要比汇编差点，但我们又不做太大型的游戏不会出现太大的差别。

### 机器介绍
要想做出GB下的游戏得先了解一下游戏机的基本性能。这里的GB只包含 第一代厚Gameboy,第二代超薄Gameboy Pocket,第三代最短暂的Gameboy Light,第四代Gameboy Color。再往后的GBA并不包含在内。CPU全系列均为z80cpu，只是不同的GB频率有区别。屏幕分辨率160x144像素，背景或窗体块大小8x8像素，对象/精灵块大小可以是8x8或8x16为了性能考虑建议使用8x16的块。大多游戏实际的角色都是16x16的像素块，当年的解决方案都是使用2个8x16拼接出来的，也就是每次角色的移动都要移动两组精灵。说到这里我们再来提下GB的层，GB一共有三个层分别是最下侧的背景层GB最多支持256个独立的块、GBC支持512个，再往上是精灵层也就是咱们一般放置在场景内移动的主角或敌人的层，如果使用8x8最多分别支持256/512个块。两个往上的是窗体层一般都是用来展示记分板，与背景层共用图像块。说完图像我们再来说颜色，最基本的GB是灰度的背景最多支持4级灰度，GBC支持4种颜色8种调色板，同一块上最多使用一种调色方案。
![gameboy layer](//blog.guohai.org/doc-pic/2020-01/gb_layer.png)


以上的讲解太抽象我们来看一个实例：

![Pokémon Gold Version](//blog.guohai.org/doc-pic/2020-01/pokemon_gold.png)

这是一个宝可梦金的截图，为了便于初期理解我去掉了调色板，左上角的框是屏幕内可以看到的范围，可以看到是由20x18个块(Tile)组成，其中每个块内有8x8个像素点。合起来也就是160x144个像素。那么每个视图内可以显示20x18也就是360个块已经超过了GB的256个限制是怎么解决的呢，答案是重复利用。仔细看画面里是大量重复的色块，组成色块的数组我们叫做map,map数组里标记的就是每一个色块的下标。
~~~ c
unsigned char rcmap[] =
{
  0x0D,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,
  0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x0F,
  0x12,0x00,0x01,0x09,0x08,0x02,0x0B,0x01,0x02,0x0C,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x12,
  0x0E,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,
  0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x10
};
~~~
是的当年的8位机就是这么多的限制，好处就是游戏在画面上没法有太大的提升下各公司会理解注重游戏性和乐趣。以及不需要太复杂美术、建模几人的小团队也能做出很棒的游戏，可惜中国在2000年时放出了游戏禁令，错过了这个机会，即使今天在家用机上中国还可以说是空白。目前所有公司都希望在手游上可以实现弯道超车。


### HelloWorld
说了这么多，也介绍了游戏机参数可能会有点迷茫，我们来搭建一个游戏开发环境吧。这里我们使用gbdk进行开发。请先前往[gbdk官网](http://gbdk.sourceforge.net/)下载开发工具包。如果你和我一样使用MAC系统，我在后面会附带一个编译好的mac下的gbdk包。可以把包解压到任意位置之后把bin目录加入到系统的path中。mac/linux机器推荐先放在/opt/gbdk下，后续教程里的Makefile我都是按这个地址来写的。准备好编译环境我们再来准备一个写代码的IDE，这里推荐微软家的VSCode免费好用还跨平台。

~~~ c
#include <gb/gb.h>
#include <stdio.h>

unsigned char st[] =
{
  0x18,0x18,0x18,0x18,0x00,0x18,0x7E,0x7E,
  0x18,0x18,0x18,0x18,0x24,0x24,0x42,0x42
};

void main()
{
    set_sprite_data(0, 1, st);
    set_sprite_tile(0, 0);
    move_sprite(0, 20, 20);
    SHOW_SPRITES;
    while (1)
    {
        if(joypad()==J_RIGHT)
        {
            scroll_sprite(0, 2, 0);
        }
        delay(50);
    }
    
}
~~~