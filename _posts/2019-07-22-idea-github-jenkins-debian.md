---
layout: post
title:  "å¿«é€Ÿç»„å»ºJavaé¡¹ç›®æŒç»­é›†æˆç¯å¢ƒ"
date:   2019-07-19 22:59:06
categories: idea github jenkins debian CI Java
---
2014å¹´æ—¶åœ¨è¿™é‡Œå°±å†™è¿‡ä¸€ç¯‡å…³äºæŒç»­é›†æˆçš„æ–‡ç« [Jenkins ä½¿ç”¨æ•™ç¨‹](/java/jenkins/2014/11/14/jenkins-use-tutorial.html)å½“æ—¶çš„Jenkinsè¿˜æ˜¯1.xç‰ˆæœ¬ï¼Œæ²¡æƒ³åˆ°5å¹´è¿‡å»äº†éƒ½9102å¹´äº†ï¼Œä»Šå¤©å’Œæœ‹å‹èŠå¤©è¿˜æœ‰å›¢é˜Ÿåœ¨ä½¿ç”¨å¼€å‘äººå‘˜æœºå™¨æ„å»ºé¡¹ç›®ï¼Œäººå·¥ftpä¼ åˆ°æœåŠ¡å™¨ä¸Šäººå·¥éƒ¨ç½²ï¼Œç´¯å—ï¼Ÿä¹Ÿä¸å®‰å…¨å•Šã€‚

æœ€è¿‘åœ¨åšä¸€ä¸ªå°çš„é¡¹ç›®ä½¿ç”¨Spring Bootæ¡†æ¶ï¼Œæ­å»ºå¼€å‘çœŸçš„ç®€å•ï¼Œä½†äººå·¥éƒ¨ç½²äº†ä¸‰æ¬¡æœåŠ¡å™¨å°±è§‰å¾—éº»çƒ¦äº†ï¼Œå°±åœ¨å®¶é‡Œçš„æ ‘è“æ´¾ä¸Šè£…äº†ä¸ªJenkinså¸®æˆ‘æ¥åšè‡ªåŠ¨éƒ¨ç½²ï¼Œç°åœ¨çš„Jenkinså·²ç»å†…ç½®äº†ä¸€ä¸ªJava servlet å®¹å™¨/åº”ç”¨ç¨‹åºæœåŠ¡å™¨ï¼Œç›´æ¥æ‰§è¡ŒjaråŒ…å³å¯ï¼Œä¸ç”¨å†åƒä¹‹å‰ä¸€æ ·è¿˜éœ€è¦è£…ä¸ªTomcatå½“servletå®¹å™¨ã€‚ä¸è¿‡æˆ‘ç°åœ¨ç”¨çš„è¿˜æ˜¯æ´¾3 CPUå¼±äº†ç‚¹ï¼Œä¸€å¼€å§‹æ„å»ºé¡¹ç›®æ´¾çš„ä¸¤ä¸ªæ ¸å¿ƒçš„CPUå°±è·‘æ»¡ï¼Œç£ç›˜IOæ€§èƒ½ä¹Ÿä¸è¡Œã€‚ç­‰å¤§å®¶å¤šç‚¹èµæˆ‘ä»¥åä¹Ÿèƒ½æ¢ä¸ªæ´¾4è€è€ğŸ˜„ğŸ˜„ã€‚

ç°åœ¨çš„æ•´ä½“æ¡†æ¶ç¯å¢ƒæ˜¯IDEAè´Ÿè´£å¼€å‘æäº¤ä»£ç ï¼Œgithubåªæ˜¯ä¸€ä¸ªä»“åº“è´Ÿè´£å­˜å‚¨ä»£ç ï¼Œåœ¨æœ‰PUSHæäº¤æ—¶è§¦å‘Jenkinså¼€å§‹åšæ„å»ºåŠ¨ä½œã€‚æ„å»ºå®ŒæˆåæŒ‰åˆ†æ”¯åå­—ã€developåˆ†æ”¯ä¸Šæµ‹è¯•æœï¼Œmasteråˆ†æ”¯ä¸Šæ­£å¼æœã€‘ä¸Šä¸åŒçš„æœåŠ¡ã€‚å¹¶é‡å¯spring jaråŒ…ã€‚å®Œæˆæ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹ã€‚

![flow](http://blog.guohai.org/doc-pic/2019-07/flow_chart.png)

## åˆ›å»ºSpring Booté¡¹ç›®ï¼Œå¹¶ç”ŸæˆJenkinsfileæ–‡ä»¶
Javaé¡¹ç›®çš„IDEç›®å‰å¾—æ¨èä¸‹[IntelliJ IDEA](https://www.jetbrains.com/idea/)æŒ‰å®˜æ–¹çš„è§£é‡ŠUltimateä¸»è¦é€‚åˆåšWEBå’Œä¼ä¸šåº”ç”¨æ¯”å¦‚æ”¯æŒSpringï¼Œè€ŒCommunityæ¯”è¾ƒé€‚åˆJVMå’ŒAndroidå¼€å‘ã€‚ä½†å› ä¸ºSpring Bootçš„å‡ºç°ï¼Œç°åœ¨ç¤¾åŒºç‰ˆæœ¬å¯¹webçš„æ”¯æŒä¹Ÿä¸é”™ï¼Œä¹Ÿå¯ä»¥æ–­ç‚¹è°ƒè¯•ã€‚åªæ˜¯å¯¹äºæ¨¡æ¿å¼•æ“æ”¯æŒçœŸçš„æ¯”è¾ƒæƒ¨ã€‚Javaè¯­è¨€æ˜¯ä¸»åŠ›å¼€å‘çš„å°±èŠ±é’±ä¹°Ultimateå§ï¼Œç©ä¸€ç©çš„ç”¨Communityå°±å¤Ÿäº†ã€‚

æƒ³è®©ç¤¾åŒºç‰ˆä½¿ç”¨å‘å¯¼åˆ›å»ºSpringé¡¹ç›®å°±éœ€è¦å…ˆå®‰è£…â€œSpring Assistantâ€è¿™ä¸ªæ’ä»¶ï¼Œä¹‹åå°±å¯ä»¥ä½¿ç”¨File->Project->Spring Assistant->Next->ç»™é¡¹ç›®èµ·ä¸ªåå­—,é€‰æ‹©ä¸‹é¡¹ç›®ç±»å‹å’Œé¡¹ç›®è¦ä½¿ç”¨çš„è¯­è¨€->Next->å‹¾é€‰ä¸‹ä½ è¦ä¾èµ–çš„ç»„ä»¶æ¯”å¦‚Spring Boot->Next->ç¡®å®šä¸‹é¡¹ç›®çš„ç›®å½•->Finishã€‚ä¸€ä¸ªæœ€ç®€å•çš„SBé¡¹ç›®åˆ›å»ºå¥½äº†ã€‚

ä¸ºäº†é…åˆJenkinsåšæ„å»ºï¼Œæˆ‘ä»¬è¿˜è¦åœ¨é¡¹ç›®ä¸­åŠ ç‚¹æ–™ã€‚ç›®å‰Jenkinsä¸»æ¨æ˜¯ä½¿ç”¨Pipelinesæ¥å®šä¹‰æ„å»ºä¸­çš„æ¯ä¸€æ­¥ï¼ŒPipelinesåˆåˆ†ä¸ºå£°æ˜å¼å’Œè„šæœ¬åŒ–ã€‚ç›¸æ¯”è„šæœ¬åŒ–çš„æµæ°´çº¿è¯­æ³•ï¼Œå£°æ˜å¼æä¾›æ›´ä¸°å¯Œçš„è¯­æ³•ç‰¹æ€§ã€‚å£°æ˜å¼éœ€è¦åœ¨é¡¹ç›®çš„æ ¹ç›®å‰åˆ›å»ºä¸€ä¸ª `Jenkinsfile`æ–‡ä»¶ï¼Œæ¥å­˜æ”¾æ„å»ºçš„è„šæœ¬ã€‚å…·ä½“çš„è¯­æ³•å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ [æµæ°´çº¿è¯­æ³•](https://jenkins.io/zh/doc/book/pipeline/syntax/) æˆ‘ä»¬ç›´æ¥ç”¨ä¸€ä¸ªæˆå“è„šæœ¬æ¥è®²è§£ã€‚

â€‹```pipelines
pipeline {
  agent any
  environment {
    //ç›®æ ‡æœåŠ¡å™¨IPä»¥åŠç™»é™†å
    TAG_SERVER = 'guohai@guohai.org'
    //ç›®æ ‡æœåŠ¡å™¨ç¨‹åºéƒ¨ç½²è·¯å¾„
    TAG_PATH = '/data/vaccine.guohai.org'
    //ç›®æ ‡æœåŠ¡å™¨å¯åŠ¨åœæ­¢springbootè„šæœ¬è·¯å¾„
    TAG_SCRIPT = '/data/spring-boot.sh'
  }

  stages {
    //æ„å»ºå—
    stage ('build') {
      steps {
         script{
            //è·å¾—mavenç¨‹åºè·¯å¾„
            def mvnHome = tool 'maven 3.6.0'
            //æ‰“åŒ…
            sh "${mvnHome}/bin/mvn clean package"
            echo "build over"
         }

      }
    }
    //è”ç½²å—
    stage ('deploy') {
        steps {
            //è®¡ç®—æœ¬åœ°æ–‡ä»¶MD5
            sh "md5sum ${WORKSPACE}/target/*.jar"
            //å› ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨ç§é’¥æ¥æ“ä½œè¿œç¨‹æœåŠ¡å™¨å†…å®¹ï¼Œä¸‹é¢çš„ä»£ç å—éœ€è¦ä½¿ç”¨withCredentialsæ‹¬èµ·æ¥ï¼Œå…¶ä¸­credentialsIdä¸ºåœ¨Jenkinsé‡Œé…ç½®çš„è¯ä¹¦ã€‚keyFileVariableä¸ºä»£ç å—ä¸­å¯ä»¥ä½¿ç”¨çš„å˜é‡å
            withCredentials([sshUserPrivateKey(credentialsId: 'guohai.org', keyFileVariable: 'guohai_org_key', passphraseVariable: '', usernameVariable: '')]) {
                //æ‹·è´æœ¬åœ°JARæ–‡ä»¶åˆ°æœåŠ¡å™¨ä¸Š
                sh "scp -i ${guohai_org_key} ${WORKSPACE}/target/*.jar ${TAG_SERVER}:${TAG_PATH}/${JOB_BASE_NAME}.jar"
                //è®¡ç®—æ‹·è´åˆ°æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ MD5ï¼Œç¡®ä¿ä¸æœ¬åœ°ä¸€è‡´ã€‚é¿å…å› ä¼ è¾“äº§ç”Ÿçš„é”™è¯¯ã€‚
                sh "ssh -i ${guohai_org_key} ${TAG_SERVER} md5sum ${TAG_PATH}/${JOB_BASE_NAME}.jar"
                //ä½¿ç”¨è„šæœ¬é‡å¯spring boot
                sh "ssh -i ${guohai_org_key} ${TAG_SERVER} ${TAG_SCRIPT} restart ${TAG_PATH}/${JOB_BASE_NAME}.jar"
            }

        }
    }
  }
}
â€‹```

## è®¾ç½®ä¸‹githubä»“åº“


## Jenkinsçš„é…ç½®