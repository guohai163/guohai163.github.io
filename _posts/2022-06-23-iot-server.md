---
layout: post
title:  "物联网的服务端设计(一)"
date:   2022-06-23 10:10:00
categories: [develop]
tags: [iot, java, netty]
image: /doc-pic/2022/iot.svg
---
这两年最火的是什么？物联网，现在连我家的电灯泡都是连网的。大量设置连网最考验的就是我们服务器的连接数量和保持情况。
最近会陆续更新一系列的文章，使用Netty做IoT服务端的设计和技术讨论文章。

## 技术选型

在Java界做socket开发最好的框架就是Netty，他本身是一个基于nio的封装，并解决了在Linux环境下nio的一些已知BUG。理想情况下前置程序应该只负责终端设备的连接保持和数据的转发，具体的业务交由后置程序来实现处理。

先来看一下我初步设计的程序架构图：

![box-server.png](/doc-pic/2022/box-server.png)

* Netty在最前端负责接收连接请求和上下行数据，实验数据使用1G内存运行容器，一个容器可以保持并处理5万个终端的连接。
* 为了加快Netty的处理速度，从终端接收上来的数据会直接放到disruptor内存队列中。
* disruptor的消费者会根据数据的类型来选择，注册终端、通过rabitmq向后置处理程序提交、通过kafka向后置提交日志
* 同时还需要做基本的心跳检查

## 通讯协议设计

通许协议的设计主要从几个方面考虑：

1. 首先要能解决TCP的粘包、半包问题
2. 通讯数据量要尽可能的小，终端设置的物联卡一般流量包都不会太大。

为了解决第一问题，一般协议会考虑使用：
1. 定长数据包方案优点是处理简单，缺点是为了照顾大数据包。会存在大量包里携带空数据。适合比较简单的数据/控制
2. 特定字符分割方式。大多采用\n来分包，比第一种相对灵活。比如redis的通许就是用的这种
3. 首字节指定包长度方式。大量基于C开发的终端设备在使用，相对第一种更灵活不浪费流量
4. 闭合包方式，最就是目前互联网协议里用的最多的json。可以使用基础器来找{}的匹配，优点时通用性好，缺点是多少会浪费流量。

