---
layout: post
title:  "在家庭网络中使用路由器翻墙，全局使用"
date:   2020-01-01 01:59:06
categories: [routeros, vpn]
tags: [routeros, vpn, gfw]
---
因我的BLOG托管在github上无法看到访问数据，这几天心血来潮给我的BLOG上挂了个站点统计脚本。发现被访问最多的文章是2015的[在ROS系统中使用VPN翻越围墙全局访问GOOGLE](/setup/ros/use/vpn/to/google/2015/02/19/setup-ros-use-vpn-to-google.html)相隔5年我再看这个文章觉得写的太粗，而且文章里有的地方在目前的网络情况下已经不可用了。所以我来更新文档来了。

先看下图是我们要实现的方案，首先我们需要在境外租用一个VPS做我们的跳板。推荐[vultr.com](https://www.vultr.com/?ref=8414686-6G)东京机房一个月5美金，使用我的推广链接新用户首充送100美金，好了广告结束。设置好后那些报404的网站的域名走VPN线路到达VPS后去8.8.8.8的这个DNS进行域名解析。解析后的IP路由器分析后会让这些IP继续走VPN线路经过VPS去访问，让404的站点回复正常。而普通的网站呢，还是走国内的你的运营商的DNS进行解析。解析得到IP后，ROS分析是普通IP后，直接去往服务器。这么做的好处

1. 404网站的域名在走到VPS后进行解析，杜绝了域名污染的问题
2. 只有报404网站的IP走VPS后进行访问，节省VPS的流量，让正常的网站不用去国外绕一圈
3. 普通网站的域名在你的运营商进行解析，解析到的IP肯定是到你延迟最低的服务器，保证普通网站能利用上各种CDN加速。
4. 以上所有设置只需要在ROS上进行设置，设置后全家享受。包括像Apple TV这种不具备翻墙功能的简单设备也可以正常使用了
![ros-vpn.png](/doc-pic/2020-03/ros-vpn.png)

### VPS环境搭建

先说服务器的地区选择，推荐香港>台湾>日本的服务器。台湾的网速也挺棒的但目前好像只有谷歌云在台湾有服务器，VPS虽然不贵，但是谷歌到大陆的流量相对会贵一些，另外访问谷歌云的页面也需要先翻墙才可使用，有点麻烦推荐已经搞定翻墙后再去这里申请个主机新用户有300没金赠送。香港：阿里云腾讯云在此都有机房但价格也不低，带宽低。日本东京挺多5美金一个月的主机流量1TB/月基本用不完，重点推荐。我之前是Linde用户后来他们的东京1机房强制下线迁移到东京2后ping延迟很糟糕。目前推荐[vultr.com](https://www.vultr.com/?ref=8414686-6G)东京机房。

另一个推荐的角度延迟丢包率是否绕路，按上面的方法申请完主机后会得到主机的IP地址使用ping进行测试，建议至少测试1000个包，看下平均延迟是否能到60ms以下，丢包率是否能低于5%。另外可以用traceroute命令来看看从你的路由器到VPS的路径是否有绕远，比如从北京到东京如果中间出现美国的IP那就会严重的绕路，这种情况下不要选择。

选择好主机后我们开始选择VPN方案旧文章推荐使用的PPTP协议目前应该已经完成无法使用了，而且iOS9后也认为这种管道协议不安全不再支持，目前推荐l2tp协议。我这里有一个已经写好的脚本，服务器的系统推荐选择Debian 9。[l2tp脚本](/doc-pic/2020-03/l2tp-server.sh)

因为我们服务器的22口会对公网开放，服务器刚申请完就会有人扫描你的22口并尝试用字典登录。为了安全申请完服务器后第一件要做的事就是把自己的公钥传到服务器以后一律使用公私钥的方式登录。并把root的密码登录方式关闭掉。接下来我们准备在服务器上开始执行上面的l2tp-server脚本。

~~~ shell
root@vps-server:~$ wget http://blog.guohai.org/doc-pic/2020-02/l2tp-server.sh -O l2tp-server.sh
root@vps-server:~$ sh l2tp-server.sh
~~~

【未完】